apiVersion: v1
kind: ServiceAccount
metadata:
  name: cluster-autoscaler-grpc-cloud-provider
  namespace: kube-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: cluster-autoscaler-grpc-cloud-provider
rules:
  - apiGroups: [""]
    resources: ["nodes"]
    verbs: ["watch", "list", "get", "update", "delete"]
  - apiGroups: [""]
    resources: ["pods/eviction"]
    verbs: ["create"]
  - apiGroups: [""]
    resources:
      - "pods"
      - "replicationcontrollers"
      - "persistentvolumeclaims"
      - "persistentvolumes"
    verbs: ["watch", "list", "get"]
  - apiGroups: ["extensions"]
    resources: ["replicasets", "daemonsets"]
    verbs: ["watch", "list", "get"]
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "create", "update", "watch"]
  - apiGroups: ["coordination.k8s.io"]
    resourceNames: ["cluster-autoscaler-grpc-cloud-provider"]
    resources: ["leases"]
    verbs: ["get", "create", "update"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: cluster-autoscaler-grpc-cloud-provider
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-autoscaler-grpc-cloud-provider
subjects:
  - kind: ServiceAccount
    name: cluster-autoscaler-grpc-cloud-provider
    namespace: kube-system
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: cluster-autoscaler-grpc-cloud-provider
  name: cluster-autoscaler-grpc-cloud-provider
  namespace: kube-system
spec:
  ports:
    - name: tcp
      port: 8086
      protocol: TCP
      targetPort: 8086
  selector:
    app: cluster-autoscaler-grpc-cloud-provider
  sessionAffinity: None
  type: ClusterIP
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cluster-autoscaler-grpc-cloud-provider
  namespace: kube-system
  labels:
    app: cluster-autoscaler-grpc-cloud-provider
spec:
  replicas: 1
  selector:
    matchLabels:
      app: cluster-autoscaler-grpc-cloud-provider
  template:
    metadata:
      labels:
        app: cluster-autoscaler-grpc-cloud-provider
      annotations:
        prometheus.io/scrape: 'true'
        prometheus.io/port: '8087'
    spec:
      serviceAccountName: cluster-autoscaler-grpc-cloud-provider
      containers:
        - image: cowell-images.tencentcloudcr.com/cowellpi/cluster-autoscaler-grpc-cloud-provider:v0.0.0
          name: cluster-autoscaler-grpc-cloud-provider
          resources:
            limits:
              cpu: 100m
              memory: 300Mi
            requests:
              cpu: 100m
              memory: 300Mi
          env:
            - name: KUBE_NODE_SSH_USER
              valueFrom:
                secretKeyRef:
                  name: kube-node-ssh-auth
                  key: KUBE_NODE_SSH_USER
            - name: KUBE_NODE_SSH_PASSWD
              valueFrom:
                secretKeyRef:
                  name: kube-node-ssh-auth
                  key: KUBE_NODE_SSH_PASSWD
          command:
            - /opt/cluster-autoscaler-grpc-cloud-provider
            - --cloud-provider=externalgrpc
            - --cloud-config=/opt/cloud-config.cfg
            - --nodegroup-config=/opt/nodegroup-config.yaml
            - --hooks-path=/opt/hooks
            - --create-parallelism=3
            - --delete-parallelism=1
            - --v=5
          volumeMounts:
            - name: config
              mountPath: /opt/cloud-config.cfg
              subPath: cloud-config.cfg
            - name: config
              mountPath: /opt/nodegroup-config.yaml
              subPath: nodegroup-config.yaml
            - name: config
              mountPath: /opt/hooks/after_created_hook.sh
              subPath: after_created_hook.sh
            - name: config
              mountPath: /opt/hooks/before_delete_hook.sh
              subPath: before_delete_hook.sh
          imagePullPolicy: "Always"
      volumes:
        - name: config
          configMap:
            name: cluster-autoscaler-grpc-cloud-provider-cm
            items:
              - key: cloud-config
                path: cloud-config.cfg
              - key: nodegroup-config
                path: nodegroup-config.yaml
              - key: after_created_hook.sh
                path: after_created_hook.sh
              - key: before_delete_hook.sh
                path: before_delete_hook.sh
---
apiVersion: v1
kind: Secret
metadata:
  name: kube-node-ssh-auth
  namespace: kube-system
type: Opaque
data:
  KUBE_NODE_SSH_USER: root
  KUBE_NODE_SSH_PASSWD: root
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: cluster-autoscaler-grpc-cloud-provider-cm
  namespace: kube-system
data:
  cloud-config: |
    address: "cluster-autoscaler-grpc-cloud-provider-service:8086"
    key: ""
    cert: ""
    cacert: ""
  nodegroup-config: |
    cloudProviderOption:
      tencentcloud:
        zhansan:
          secretId: "XXX"
          secretKey: "YYY"
      instanceParameter:
        tencentcloud_beijing5_10-2-20-x:
          providerIdTemplate: "externalgrpc://tencentcloud/zhansan/ap-beijing/{{InstanceID}}"
          parameter:
            InstanceChargeType: "PREPAID"
            InstanceChargePrepaid:
              Period: 1
              RenewFlag: "NOTIFY_AND_AUTO_RENEW"
            Placement:
              ProjectId: 123456
              Zone: "ap-beijing-5"
            InstanceType: "S5.2XLARGE16"
            ImageId: "img-111111"
            SystemDisk:
              DiskType: "CLOUD_PREMIUM"
              DiskSize: 200
              DiskName: "K8S-NODE-SYSTEM-DISK"
            VirtualPrivateCloud:
              VpcId: "vpc-222222"
              SubnetId: "subnet-333333"
            InstanceCount: 1
            InstanceName: "K8S-NODE"
            SecurityGroupIds:
              - "sg-444444"
            TagSpecification:
              -  ResourceType: "instance"
                 Tags:
                   - Key: "env"
                     Value: "test"
    nodeGroups:
      - id: "master"
        minSize: 3
        maxSize: 3
        targetSize: 3
        nodeTemplate:
          labels:
            node-role.kubernetes.io/master: ""
          annotations:
          capacity:
            cpu: "8"
            memory: "16G"
            ephemeral-storage: "200G"
          allocatable:
            cpu: "8"
            memory: "16G"
            ephemeral-storage: "200G"
          taints:
            - key: "node-role.kubernetes.io/master"
              effect: "NoSchedule"
      - id: "worker-addons"
        minSize: 3
        maxSize: 3
        targetSize: 3
        nodeTemplate:
          labels:
            node-role.kubernetes.io/worker-addons: ""
          annotations:
          capacity:
            cpu: "48"
            memory: "16G"
            ephemeral-storage: "200G"
          allocatable:
            cpu: "8"
            memory: "16G"
            ephemeral-storage: "200G"
          taints:
            - key: "CriticalAddonsOnly"
              effect: "NoSchedule"
      - id: "autoscaler-test"
        minSize: 0
        maxSize: 10
        targetSize: 0
        autoscalingOptions:
          scaleDownUtilizationThreshold: 0.5
          scaleDownGpuUtilizationThreshold: 0.5
          scaleDownUnneededTime: "40m"
          scaleDownUnreadyTime: "10m"
        instances:
          - id: 6ddb4200
            name: 1.2.3.4
            ip: 1.2.3.4
            providerID: externalgrpc://tencentcloud/zhansan/ap-beijing/ins-aaaaaaa
            stage: Deleted
            updateTime: 2025-09-06T00:50:31.994536143+08:00
        nodeTemplate:
          labels:
            "node-role.kubernetes.io/autoscaler-test": ""
          annotations:
          capacity:
            cpu: "8"
            memory: "16G"
            ephemeral-storage: "200G"
          allocatable:
            cpu: "8"
            memory: "16G"
            ephemeral-storage: "200G"
          taints:
  after_created_hook.sh: |
    #!/bin/bash

    set -e

    # 会将env文件中内置的环境变量注入此脚本
    node_name=${NODE_NAME}
    node_ip=${NODE_IP}
    provider_id=${PROVIDER_ID}


    # 日志函数
    log_info() {
        echo "$(date '+%Y-%m-%d %H:%M:%S') [INFO] $1"
    }

    log_warn() {
        echo "$(date '+%Y-%m-%d %H:%M:%S') [WARN] $1"
    }

    log_error() {
        echo "$(date '+%Y-%m-%d %H:%M:%S') [ERROR] $1"
    }


    # 设置主机名
    set_hostname() {
        local current_hostname=$(hostname)
        if [ "$current_hostname" != "${node_name}" ]; then
            log_info "Setting hostname to ${node_name}"
            sudo /usr/bin/hostnamectl set-hostname "${node_name}"
            log_info "Hostname set successfully"
        else
            log_info "Hostname is already set to ${node_name}, skipping"
        fi
    }

    # 配置Hosts文件
    configure_hosts() {
        local hosts_lines=(
            "127.0.0.1 ${node_name}"
            "10.2.13.10 kubernetes.default.svc"
            "10.8.16.99 docker-repo.gaojihealth.cn"
            "10.8.51.100 rancher.cowelltech.com"
            "10.2.6.3 cowell-images.tencentcloudcr.com"
        )

        for line in "${hosts_lines[@]}"; do
            if ! grep -q "^${line}" /etc/hosts; then
                log_info "Adding '$line' to /etc/hosts"
                echo "$line" | sudo tee -a /etc/hosts > /dev/null
            else
                log_info "'$line' already exists in /etc/hosts, skipping"
            fi
        done
        log_info "Hosts configuration completed"
    }

    # 安装Kubernetes组件
    install_k8s_components() {
        local version="1.18.19-00"
        local packages=("kubeadm" "kubectl" "kubelet")

        log_info "Updating package list"
        sudo apt-get update

        for pkg in "${packages[@]}"; do
            if dpkg -l | grep -q "ii  $pkg"; then
                local current_version=$(dpkg -s $pkg 2>/dev/null | grep Version | awk '{print $2}' || echo "")
                if [ "$current_version" != "$version" ]; then
                    log_info "Reinstalling $pkg (current: $current_version, desired: $version)"
                    sudo apt-get install -y --allow-downgrades "$pkg=$version"
                else
                    log_info "$pkg is already installed with correct version $version"
                fi
            else
                log_info "Installing $pkg=$version"
                sudo apt-get install -y "$pkg=$version"
            fi
        done
        log_info "Kubernetes components installation completed"
    }

    set_kubelet_provider_id() {
        echo "KUBELET_EXTRA_ARGS=\"--provider-id=${provider_id}\"" | sudo tee /etc/default/kubelet > /dev/null
        log_info "Adding KUBELET_EXTRA_ARGS to /etc/default/kubelet"
    }

    # 加入Kubernetes集群
    join_cluster() {
        log_info "Resetting kubeadm and joining cluster"
        yes | sudo kubeadm reset 2>/dev/null || true

        # 加入集群
        log_info "Joining Kubernetes cluster"
        sudo kubeadm join kubernetes.default.svc:6443 \
            --token 6qeuu1.o73nys8e313uabkb \
            --discovery-token-ca-cert-hash sha256:f6123a5713c200d94053234a26c17389d8629d9f0b56a238514aa66eeb5aeeb4

        log_info "Successfully joined Kubernetes cluster"
    }

    add_host_to_cmdb(){
        local bk_user="kubernetes"
        local uni_resource_name="Saas-Node-$(echo $node_ip | tr \. \_)"
        local bk_create=$(date "+%Y-%m-%d")
        local bk_env="1"
        local bk_func="kubernetes"

        local request_data=$(cat << EOF
              {
                  "bk_supplier_id": 0,
                  "bk_biz_id": 19,
                  "bk_app_code": "saas-sops",
                  "bk_app_secret": "24eb30a5-1000-4d8a-9e56-1adde91fd825",
                  "bk_username": "saas-sops",
                  "host_info": {
                      "8": {
                          "uni_resource_name": "${uni_resource_name}",
                          "bk_host_innerip": "${node_ip}",
                          "bk_cloud_id": 8,
                          "bk_create": "${bk_create}",
                          "bk_over": "2666-06-06",
                          "bk_env": "${bk_env}",
                          "bk_func": "${bk_func}",
                          "bk_user": "${bk_user}",
                          "bk_os_type": "1"
                      }
                  }
              }
    EOF
    )

        log_info "send request to cmdb: ${request_data}"

        local response
        response=$(curl -sS -X POST \
                    --insecure \
                    --connect-timeout 30 \
                    --max-time 60 \
                    --header "Content-Type: application/json" \
                    --data "${request_data}" \
                    --resolve paas.cowelltech.com:443:10.8.8.20 \
                    'https://paas.cowelltech.com/api/c/compapi/v2/cc/add_host_to_resource/' 2>&1)
        local exit_code=$?

        if [[ ${exit_code} -eq 0 ]]; then
            log_info "add ${node_ip} to cmdb successfully"
        else
            log_error "add ${node_ip} to cmdb failed, code: ${exit_code}"
            log_error "error response: ${response}"
        fi
    }

    # 主函数
    main() {
        log_info "starting exec after_created_hook script"

        # 系统刚起来等待10s中稳定
        sleep 10
    
        set_hostname
        configure_hosts
        install_k8s_components
        set_kubelet_provider_id
        join_cluster
        add_host_to_cmdb

        log_info "exec after_created_hook script successfully"
    }

    main

  before_delete_hook.sh: |
    #!/bin/bash
    
    set -e
    
    
    # 日志函数
    log_info() {
        echo "$(date '+%Y-%m-%d %H:%M:%S') [INFO] $1"
    }
    
    log_warn() {
        echo "$(date '+%Y-%m-%d %H:%M:%S') [WARN] $1"
    }
    
    log_error() {
        echo "$(date '+%Y-%m-%d %H:%M:%S') [ERROR] $1"
    }
    
    
    # 主函数
    main() {
        log_info "starting exec before_delete_hook script"
    
    
        log_info "exec before_delete_hook script successfully"
    }
    
    main